<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Number Scanner</title>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }
        #camera-container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            position: relative;
        }
        #video {
            width: 100%;
            border: 2px solid #25D366;
            display: none;
        }
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        #viewfinder {
            width: 80%;
            height: 150px;
            border: 3px dashed red;
            margin-bottom: 10px;
        }
        button {
            background: #25D366;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        #error {
            color: red;
            margin: 10px;
        }
        #success {
            color: green;
        }
        .debug {
            font-family: monospace;
            background: #f0f0f0;
            padding: 10px;
            margin: 10px;
            text-align: left;
            max-width: 500px;
            margin: 10px auto;
        }
    </style>
</head>
<body>
    <h1>WhatsApp Number Scanner</h1>
    
    <div id="camera-container">
        <video id="video" playsinline></video>
        <div id="overlay">
            <div id="viewfinder"></div>
            <div id="camera-status">Camera not active</div>
        </div>
    </div>
    
    <div>
        <button id="startBtn">Start Camera</button>
        <button id="stopBtn" disabled>Stop Camera</button>
    </div>
    
    <div id="error"></div>
    <div id="success"></div>
    
    <div class="debug">
        <h3>Troubleshooting Info:</h3>
        <div id="debug-info"></div>
    </div>

    <script>
        // Elements
        const video = document.getElementById('video');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const errorElement = document.getElementById('error');
        const successElement = document.getElementById('success');
        const cameraStatus = document.getElementById('camera-status');
        const debugInfo = document.getElementById('debug-info');
        
        let stream = null;
        
        // Debug logging
        function logDebug(message) {
            debugInfo.innerHTML += `${new Date().toLocaleTimeString()}: ${message}<br>`;
            debugInfo.scrollTop = debugInfo.scrollHeight;
        }
        
        // Check camera permissions
        async function checkPermissions() {
            try {
                const permissions = await navigator.permissions.query({ name: 'camera' });
                logDebug(`Camera permission state: ${permissions.state}`);
                
                permissions.onchange = () => {
                    logDebug(`Camera permission changed to: ${permissions.state}`);
                };
                
                return permissions.state === 'granted';
            } catch (error) {
                logDebug(`Permission API error: ${error}`);
                return false;
            }
        }
        
        // Get camera stream
        async function startCamera() {
            logDebug("Attempting to start camera...");
            
            try {
                // Check if we already have a stream
                if (stream) {
                    logDebug("Stopping existing stream");
                    stopCamera();
                }
                
                // Check permissions first
                const hasPermission = await checkPermissions();
                if (!hasPermission) {
                    logDebug("Camera permission not granted");
                }
                
                // Get available devices
                const devices = await navigator.mediaDevices.enumerateDevices();
                const cameras = devices.filter(device => device.kind === 'videoinput');
                logDebug(`Found ${cameras.length} camera(s)`);
                
                if (cameras.length === 0) {
                    throw new Error("No cameras found");
                }
                
                // Try to get back camera first
                const constraints = {
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'environment'
                    }
                };
                
                logDebug("Trying to get camera with constraints: " + JSON.stringify(constraints));
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                video.style.display = 'block';
                cameraStatus.textContent = "Camera active";
                cameraStatus.style.color = "green";
                startBtn.disabled = true;
                stopBtn.disabled = false;
                
                logDebug("Camera started successfully");
                
                // Start scanning
                startScanning();
                
            } catch (error) {
                errorElement.textContent = `Camera Error: ${error.message}`;
                logDebug(`Camera Error: ${error.message}`);
                
                // Try fallback constraints
                if (error.name === 'OverconstrainedError' || error.name === 'ConstraintNotSatisfiedError') {
                    logDebug("Trying fallback constraints...");
                    try {
                        const fallbackConstraints = { video: true };
                        stream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
                        video.srcObject = stream;
                        video.style.display = 'block';
                        cameraStatus.textContent = "Camera active (fallback mode)";
                        cameraStatus.style.color = "green";
                        startBtn.disabled = true;
                        stopBtn.disabled = false;
                        logDebug("Camera started with fallback constraints");
                        startScanning();
                    } catch (fallbackError) {
                        errorElement.textContent = `Fallback Failed: ${fallbackError.message}`;
                        logDebug(`Fallback Error: ${fallbackError.message}`);
                    }
                }
            }
        }
        
        // Stop camera
        function stopCamera() {
            if (stream) {
                logDebug("Stopping camera...");
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                video.style.display = 'none';
                cameraStatus.textContent = "Camera stopped";
                cameraStatus.style.color = "red";
                startBtn.disabled = false;
                stopBtn.disabled = true;
                stream = null;
                logDebug("Camera stopped successfully");
            }
        }
        
        // Start scanning
        function startScanning() {
            logDebug("Starting scanner...");
            const codeReader = new ZXing.BrowserQRCodeReader();
            
            codeReader.decodeFromVideoElement(video, (result, error) => {
                if (result) {
                    logDebug(`Scanned: ${result.text}`);
                    const number = extractPhoneNumber(result.text);
                    if (number.length === 10) {
                        successElement.textContent = `Detected: ${number}`;
                        setTimeout(() => {
                            window.open(`https://wa.me/91${number}`, '_blank');
                        }, 1000);
                    }
                }
                
                if (error && !(error instanceof ZXing.NotFoundException)) {
                    logDebug(`Scan Error: ${error}`);
                }
            });
        }
        
        // Extract phone number
        function extractPhoneNumber(text) {
            // Remove all non-digit characters
            const digits = text.replace(/\D/g, '');
            // Take last 10 digits
            return digits.slice(-10);
        }
        
        // Event listeners
        startBtn.addEventListener('click', startCamera);
        stopBtn.addEventListener('click', stopCamera);
        
        // Initial debug info
        logDebug("Page loaded");
        logDebug(`User Agent: ${navigator.userAgent}`);
        logDebug(`HTTPS: ${window.location.protocol === 'https:'}`);
        logDebug(`Localhost: ${window.location.hostname === 'localhost' || 
                  window.location.hostname === '127.0.0.1'}`);
    </script>
</body>
</html>
