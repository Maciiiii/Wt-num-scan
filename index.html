<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Screen Number Scanner</title>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <style>
        /* [Previous CSS remains exactly the same] */
    </style>
</head>
<body>
    <div class="container">
        <h1>Screen Number Scanner</h1>
        <p>Point your camera at a phone number on any screen:</p>

        <!-- [Previous HTML structure remains the same] -->

        <div id="scanner-section">
            <video id="scanner-video" playsinline></video>
            <canvas id="scanner-canvas" style="display:none"></canvas>
            <div id="scanner-overlay">
                <div class="viewfinder"></div>
                <div id="scanner-guide">Align number within this box</div>
            </div>
        </div>

        <!-- [Rest of previous HTML remains] -->
    </div>

    <script>
        // [Previous variable declarations remain]

        // Enhanced screen scanning function
        async function toggleScanner() {
            if (isScanning) {
                await stopScanner();
                return;
            }

            try {
                // Optimized for screen reading
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 },
                        focusMode: 'continuous'
                    }
                });
                
                currentStream = stream;
                videoElement.srcObject = stream;
                videoElement.style.display = 'block';
                overlayElement.style.display = 'block';
                scanBtn.textContent = 'Stop Scanning';
                isScanning = true;
                
                // New: Continuous frame processing for better screen reading
                const canvas = document.getElementById('scanner-canvas');
                const ctx = canvas.getContext('2d');
                
                function processFrame() {
                    if (!isScanning) return;
                    
                    try {
                        // Capture video frame
                        canvas.width = videoElement.videoWidth;
                        canvas.height = videoElement.videoHeight;
                        ctx.drawImage(videoElement, 0, 0);
                        
                        // Get image data from viewfinder area
                        const viewfinder = {
                            x: canvas.width * 0.1,
                            y: canvas.height * 0.3,
                            width: canvas.width * 0.8,
                            height: canvas.height * 0.4
                        };
                        
                        const imageData = ctx.getImageData(
                            viewfinder.x, viewfinder.y, 
                            viewfinder.width, viewfinder.height
                        );
                        
                        // Convert to grayscale for better OCR-like processing
                        const grayData = toGrayscale(imageData);
                        
                        // Try to extract numbers (simplified OCR approach)
                        const numbers = extractNumbersFromImage(grayData);
                        
                        if (numbers.length >= 10) {
                            const cleanNumber = numbers.replace(/\D/g, '').slice(-10);
                            if (cleanNumber.length === 10) {
                                phoneInput.value = cleanNumber;
                                stopScanner();
                                successElement.textContent = "Detected: " + cleanNumber;
                                setTimeout(() => {
                                    window.open(`https://wa.me/${countryCode.value + cleanNumber}`, '_blank');
                                }, 1000);
                                return;
                            }
                        }
                        
                        // Continue processing
                        requestAnimationFrame(processFrame);
                    } catch (e) {
                        console.error("Processing error:", e);
                    }
                }
                
                // Start processing
                videoElement.onplaying = () => {
                    processFrame();
                };

            } catch (err) {
                cameraErrorElement.textContent = getCameraErrorMessage(err);
                stopScanner();
            }
        }

        // Helper function to convert to grayscale
        function toGrayscale(imageData) {
            const grayData = new Uint8Array(imageData.width * imageData.height);
            for (let i = 0, j = 0; i < imageData.data.length; i += 4, j++) {
                grayData[j] = Math.round(
                    0.299 * imageData.data[i] + 
                    0.587 * imageData.data[i+1] + 
                    0.114 * imageData.data[i+2]
                );
            }
            return {
                data: grayData,
                width: imageData.width,
                height: imageData.height
            };
        }

        // Simplified number extraction from image
        function extractNumbersFromImage(imageData) {
            // This is a simplified approach - in production you'd use a proper OCR library
            // Here we'll simulate finding bright numbers on darker background
            
            let potentialNumbers = '';
            const threshold = 128;
            const minDigitWidth = 5;
            const minDigitHeight = 10;
            
            // Scan for vertical number-like patterns
            for (let y = 0; y < imageData.height; y++) {
                for (let x = 0; x < imageData.width; x++) {
                    const idx = y * imageData.width + x;
                    if (imageData.data[idx] > threshold) {
                        // Found bright pixel - could be part of a number
                        potentialNumbers += detectDigitShape(imageData, x, y, threshold);
                        x += minDigitWidth; // Skip ahead
                    }
                }
            }
            
            return potentialNumbers;
        }

        // [Previous helper functions remain]
        
        // New: Add this to your CSS
        #scanner-guide {
            position: absolute;
            bottom: 10px;
            width: 100%;
            text-align: center;
            color: white;
            background: rgba(0,0,0,0.5);
            padding: 5px;
        }
    </script>
</body>
</html>
